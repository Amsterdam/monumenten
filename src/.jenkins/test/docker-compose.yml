version: "3.0"
services:
  database:
    image: build.datapunt.amsterdam.nl:5000/atlas/postgres
    environment:
      POSTGRES_DB: monumenten
      POSTGRES_USER: monumenten
      POSTGRES_PASSWORD: insecure

  elasticsearch:
    image: build.datapunt.amsterdam.nl:5000/atlas/elasticsearch5:latest
    command:  elasticsearch -Ehttp.host=0.0.0.0 -Etransport.host=127.0.0.1

  tests:
    build: ../../
    links:
      - elasticsearch
      - database
    environment:
      DATABASE_NAME: monumenten
      DATABASE_USER: monumenten
      DATABASE_PASSWORD: insecure
      JWT_SHARED_SECRET_KEY: insecure1234567890
    command: >
      bash -c "/app/.jenkins/docker-wait.sh \
              && cd /app/.jenkins/test/ \
              && ./docker-code-check.sh \
              && ./docker-test.sh"
